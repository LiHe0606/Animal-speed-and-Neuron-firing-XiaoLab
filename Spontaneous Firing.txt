clear all;
close all;
clc;

%% 1. Read Excel Data
filename = 'YourFileName.xlsx';  % Please modify to actual file name

% Read data
try
    % Attempt to use xlsread (compatible with older versions)
    [num_data, txt_data, raw_data] = xlsread(filename);
    
    % Extract data
    if size(num_data, 2) >= 2
        time_points = num_data(:, 1);  % First column: firing time points
        cell_numbers = num_data(:, 2); % Second column: cell numbers
    else
        error('Insufficient number of data columns. Ensure Excel file has at least two columns.');
    end
    
catch ME
    % If xlsread fails, try alternative method
    disp('xlsread failed. Trying alternative method...');
    
    % Method 2: Use importdata
    data = importdata(filename);
    if isstruct(data)
        time_points = data.data(:, 1);
        cell_numbers = data.data(:, 2);
    else
        error('Unable to read Excel file. Please check filename and format.');
    end
end

%% 2. Data Validation
% Ensure data is within -10 to +10 second range
valid_indices = (time_points >= -10 & time_points <= 10);
time_points = time_points(valid_indices);
cell_numbers = cell_numbers(valid_indices);

% Determine cell number range
unique_cells = unique(cell_numbers);
num_cells = length(unique_cells);

disp(['Number of cells detected: ' num2str(num_cells)]);
disp(['Cell number range: ' num2str(min(unique_cells)) ' to ' num2str(max(unique_cells))]);

if num_cells > 29
    warning(['More than 29 cells detected. Only using first 29 cells.']);
    % Only keep data for first 29 cells
    valid_indices = ismember(cell_numbers, 1:29);
    time_points = time_points(valid_indices);
    cell_numbers = cell_numbers(valid_indices);
elseif num_cells < 29
    warning(['Only ' num2str(num_cells) ' cells detected. Expected 29.']);
end

%% 3. Parameter Settings
% Time window size (seconds)
time_window = 0.1;  % 100ms window (adjustable as needed)

% Stimulus time point (if known, for marking)
stim_time = 0;  % Assuming stimulus at t=0, adjust according to actual situation

% Time range: -10 to +10 seconds
min_time = -10;
max_time = 10;
total_time = max_time - min_time;

% Calculate number of time bins
num_time_bins = ceil(total_time / time_window);

% Create time axis
time_axis = linspace(min_time, max_time, num_time_bins);

%% 4. Create 29-Row Firing Rate Matrix (one row per cell)
% Initialize matrix: rows = cell numbers, columns = time windows
freq_matrix_29 = zeros(29, num_time_bins);

% Calculate firing rate for each cell
for cell_num = 1:29
    % Get all firing time points for this cell
    cell_indices = (cell_numbers == cell_num);
    cell_times = time_points(cell_indices);
    
    if isempty(cell_times)
        disp(['Warning: Cell ' num2str(cell_num) ' has no firing data']);
        continue;  % Skip if no data for this cell
    end
    
    % Count firing events in each time window
    for bin_idx = 1:num_time_bins
        % Calculate current time window start and end times
        bin_start = time_axis(bin_idx);
        bin_end = min(time_axis(bin_idx) + time_window, max_time);
        
        % Count firing events within this time window
        spike_count = sum((cell_times >= bin_start) & (cell_times < bin_end));
        
        % Calculate firing rate (Hz, spikes per second)
        freq_matrix_29(cell_num, bin_idx) = spike_count / time_window;
    end
end

%% 5. Smoothing Processing
% Apply simple moving average smoothing
smooth_kernel = [0.25, 0.5, 0.25];  % 3-point smoothing
freq_matrix_29_smoothed = zeros(size(freq_matrix_29));

for cell_num = 1:29
    % Smooth each row
    freq_matrix_29_smoothed(cell_num, :) = conv(freq_matrix_29(cell_num, :), smooth_kernel, 'same');
end

%% 6. Plot Original Scatter Plot
figure('Position', [50, 50, 1200, 600]);

% Subplot 1: Original Scatter Plot
subplot(2, 2, 1);
hold on;
colors = jet(29);  % Use jet colormap to assign different colors to different cells
for cell_num = 1:29
    cell_indices = (cell_numbers == cell_num);
    if any(cell_indices)
        plot(time_points(cell_indices), cell_numbers(cell_indices), ...
             'o', 'MarkerSize', 2, 'MarkerFaceColor', colors(cell_num, :), ...
             'MarkerEdgeColor', colors(cell_num, :));
    end
end
xlabel('Time (s)', 'FontSize', 10);
ylabel('Cell Number', 'FontSize', 10);
title('Original Firing Scatter Plot of 29 Cells', 'FontSize', 12);
xlim([-10, 10]);
ylim([0.5, 29.5]);
grid on;

% Mark stimulus time point (if applicable)
if stim_time ~= 0
    hold on;
    plot([stim_time, stim_time], [0.5, 29.5], 'r--', 'LineWidth', 1.5);
    hold off;
end
hold off;

% Subplot 2: Firing Rate Heatmap
subplot(2, 2, 2);
imagesc(time_axis, 1:29, freq_matrix_29_smoothed);
colormap('hot');
colorbar;
xlabel('Time (s)', 'FontSize', 10);
ylabel('Cell Number', 'FontSize', 10);
title('Firing Rate Heatmap of 29 Cells', 'FontSize', 12);
set(gca, 'YTick', 1:29);
set(gca, 'YTickLabel', arrayfun(@(x) sprintf('C%d', x), 1:29, 'UniformOutput', false));
grid on;

% Mark stimulus time point (if applicable)
if stim_time ~= 0
    hold on;
    plot([stim_time, stim_time], [0.5, 29.5], 'g--', 'LineWidth', 2);
    hold off;
end

% Subplot 3: Average Firing Rate Bar Chart
subplot(2, 2, 3);
cell_mean_freq = mean(freq_matrix_29_smoothed, 2);
bar(1:29, cell_mean_freq, 'b');
xlabel('Cell Number', 'FontSize', 10);
ylabel('Average Firing Rate (Hz)', 'FontSize', 10);
title('Average Firing Rate for Each Cell', 'FontSize', 12);
grid on;
xlim([0.5, 29.5]);

% Subplot 4: Average Firing Rate Curve for All Cells
subplot(2, 2, 4);
mean_all_cells = mean(freq_matrix_29_smoothed, 1);
std_all_cells = std(freq_matrix_29_smoothed, 0, 1);

plot(time_axis, mean_all_cells, 'b-', 'LineWidth', 2);
hold on;
fill([time_axis, fliplr(time_axis)], ...
     [mean_all_cells - std_all_cells, fliplr(mean_all_cells + std_all_cells)], ...
     'b', 'FaceAlpha', 0.3, 'EdgeColor', 'none');
xlabel('Time (s)', 'FontSize', 10);
ylabel('Average Firing Rate (Hz)', 'FontSize', 10);
title('Average Firing Rate for All Cells (± Standard Deviation)', 'FontSize', 12);
grid on;

% Mark stimulus time point (if applicable)
if stim_time ~= 0
    plot([stim_time, stim_time], ylim, 'r--', 'LineWidth', 1.5);
end
hold off;

%% 7. Plot Single Firing Rate Heatmap (Large Figure)
figure('Position', [100, 100, 1400, 500]);

imagesc(time_axis, 1:29, freq_matrix_29_smoothed);
colormap('hot');
colorbar;

% Add labels
xlabel('Time (s)', 'FontSize', 14);
ylabel('Cell Number', 'FontSize', 14);
title('Firing Rate Heatmap of 29 Cells (-10 to +10 Seconds)', 'FontSize', 16);

% Set y-axis ticks
set(gca, 'YTick', 1:29);
set(gca, 'YTickLabel', arrayfun(@(x) sprintf('Cell %d', x), 1:29, 'UniformOutput', false));

% Mark stimulus time point (if applicable)
if stim_time ~= 0
    hold on;
    plot([stim_time, stim_time], [0.5, 29.5], 'g--', 'LineWidth', 2.5);
    text(stim_time+0.2, 28, 'Stimulus Time', 'Color', 'g', 'FontSize', 12, 'FontWeight', 'bold');
    hold off;
end

grid on;
set(gca, 'GridColor', 'w', 'GridAlpha', 0.3);

%% 8. Plot Firing Rate Curves for Representative Cells
figure('Position', [150, 150, 1200, 400]);

% Select some representative cells
representative_cells = [1, 7, 14, 21, 29];

% Subplot 1: Firing Rate Curves of Representative Cells
subplot(1, 2, 1);
hold on;
colors = {'r', 'g', 'b', 'm', 'k'};
line_styles = {'-', '--', ':', '-.', '-'};
for i = 1:length(representative_cells)
    cell_num = representative_cells(i);
    plot(time_axis, freq_matrix_29_smoothed(cell_num, :), ...
         'Color', colors{i}, 'LineStyle', line_styles{i}, 'LineWidth', 2);
end
xlabel('Time (s)', 'FontSize', 12);
ylabel('Firing Rate (Hz)', 'FontSize', 12);
title('Firing Rate Curves of Representative Cells', 'FontSize', 14);
legend(arrayfun(@(x) sprintf('Cell %d', x), representative_cells, 'UniformOutput', false), ...
       'Location', 'best');
grid on;

% Mark stimulus time point (if applicable)
if stim_time ~= 0
    plot([stim_time, stim_time], ylim, 'k--', 'LineWidth', 1.5);
end
hold off;

% Subplot 2: Firing Rate Distribution Histogram
subplot(1, 2, 2);
% Flatten all firing rate values into 1D array
all_freq_values = freq_matrix_29_smoothed(:);
all_freq_values = all_freq_values(all_freq_values > 0);  % Only consider cases with firing

histogram(all_freq_values, 30, 'FaceColor', 'b', 'EdgeColor', 'k');
xlabel('Firing Rate (Hz)', 'FontSize', 12);
ylabel('Frequency Count', 'FontSize', 12);
title('Firing Rate Distribution for All Cells', 'FontSize', 14);
grid on;

% Add statistical information text
stats_text = {sprintf('Minimum: %.2f Hz', min(all_freq_values)), ...
              sprintf('Maximum: %.2f Hz', max(all_freq_values)), ...
              sprintf('Mean: %.2f Hz', mean(all_freq_values)), ...
              sprintf('Median: %.2f Hz', median(all_freq_values))};
text(0.7, 0.9, stats_text, 'Units', 'normalized', 'FontSize', 10, ...
     'VerticalAlignment', 'top', 'BackgroundColor', 'w');

%% 9. Plot Pre- and Post-Stimulus Comparison (if stimulus time is known)
if stim_time ~= 0
    figure('Position', [200, 200, 1200, 400]);
    
    % Define pre- and post-stimulus time windows
    pre_stim_window = [-2, 0];  % 2 seconds before stimulus
    post_stim_window = [0, 2];  % 2 seconds after stimulus
    
    % Find corresponding time window indices
    pre_start_idx = find(time_axis >= pre_stim_window(1), 1, 'first');
    pre_end_idx = find(time_axis <= pre_stim_window(2), 1, 'last');
    
    post_start_idx = find(time_axis >= post_stim_window(1), 1, 'first');
    post_end_idx = find(time_axis <= post_stim_window(2), 1, 'last');
    
    % Calculate average firing rate for each cell before and after stimulus
    pre_stim_mean = mean(freq_matrix_29_smoothed(:, pre_start_idx:pre_end_idx), 2);
    post_stim_mean = mean(freq_matrix_29_smoothed(:, post_start_idx:post_end_idx), 2);
    
    % Subplot 1: Pre- and Post-Stimulus Comparison Bar Chart
    subplot(1, 3, 1);
    bar_data = [pre_stim_mean, post_stim_mean];
    bar(1:29, bar_data);
    xlabel('Cell Number', 'FontSize', 12);
    ylabel('Average Firing Rate (Hz)', 'FontSize', 12);
    title('Comparison of Average Firing Rates Before and After Stimulus', 'FontSize', 14);
    legend('Pre-Stimulus (-2~0s)', 'Post-Stimulus (0~2s)', 'Location', 'best');
    grid on;
    xlim([0.5, 29.5]);
    
    % Subplot 2: Pre- and Post-Stimulus Difference Scatter Plot
    subplot(1, 3, 2);
    scatter(pre_stim_mean, post_stim_mean, 50, 'b', 'filled');
    hold on;
    % Add diagonal line (indicating no change)
    min_val = min([pre_stim_mean; post_stim_mean]);
    max_val = max([pre_stim_mean; post_stim_mean]);
    plot([min_val, max_val], [min_val, max_val], 'r--', 'LineWidth', 2);
    xlabel('Pre-Stimulus Average Firing Rate (Hz)', 'FontSize', 12);
    ylabel('Post-Stimulus Average Firing Rate (Hz)', 'FontSize', 12);
    title('Correlation Between Pre- and Post-Stimulus Firing Rates', 'FontSize', 14);
    grid on;
    hold off;
    
    % Subplot 3: Stimulus Response Change Rate
    subplot(1, 3, 3);
    response_change = (post_stim_mean - pre_stim_mean) ./ pre_stim_mean * 100;
    % Avoid division by zero
    response_change(isinf(response_change) | isnan(response_change)) = 0;
    
    bar(1:29, response_change, 'b');
    xlabel('Cell Number', 'FontSize', 12);
    ylabel('Change Rate (%)', 'FontSize', 12);
    title('Stimulus Response Change Rate (Post-Stimulus Relative to Pre-Stimulus)', 'FontSize', 14);
    grid on;
    xlim([0.5, 29.5]);
    
    % Add zero line
    hold on;
    plot([0.5, 29.5], [0, 0], 'k-', 'LineWidth', 1.5);
    hold off;
end

%% 10. Save Results
% Save data to mat file
save('29cells_frequency_data.mat', ...
     'freq_matrix_29', 'freq_matrix_29_smoothed', ...
     'time_axis', 'time_window', 'stim_time');

% Save cell average firing rates to Excel
cell_stats = cell(30, 4);
cell_stats{1,1} = 'Cell Number';
cell_stats{1,2} = 'Average Firing Rate (Hz)';
cell_stats{1,3} = 'Maximum Firing Rate (Hz)';
cell_stats{1,4} = 'Minimum Firing Rate (Hz)';

for i = 1:29
    cell_stats{i+1,1} = i;
    cell_stats{i+1,2} = mean(freq_matrix_29_smoothed(i, :));
    cell_stats{i+1,3} = max(freq_matrix_29_smoothed(i, :));
    cell_stats{i+1,4} = min(freq_matrix_29_smoothed(i, :));
end

% Write to Excel file
xlswrite('29cells_statistics.xlsx', cell_stats);

% Save figures
print('29cells_heatmap_composite.png', '-dpng', '-r300');
print('29cells_heatmap_large.png', '-dpng', '-r300');
print('29cells_frequency_curves.png', '-dpng', '-r300');

if stim_time ~= 0
    print('29cells_stim_response.png', '-dpng', '-r300');
end

% Save as PDF
print('29cells_heatmap_composite.pdf', '-dpdf');
print('29cells_heatmap_large.pdf', '-dpdf');

%% 11. Output Statistical Information
disp('=== Data Processing Complete ===');
disp(['Time window size: ' num2str(time_window*1000) ' ms']);
disp(['Time range: ' num2str(min_time) ' to ' num2str(max_time) ' seconds']);
disp(['Number of time bins: ' num2str(num_time_bins)]);
disp(['Matrix size: 29 × ' num2str(num_time_bins)]);
disp(['Maximum firing rate: ' num2str(max(freq_matrix_29_smoothed(:))) ' Hz']);
disp(['Minimum firing rate: ' num2str(min(freq_matrix_29_smoothed(:))) ' Hz']);
disp(['Average firing rate (all cells): ' num2str(mean(freq_matrix_29_smoothed(:))) ' Hz']);

% Display average firing rates for first 5 cells
disp('Average firing rates for first 5 cells (Hz):');
for i = 1:min(5, 29)
    disp(['  Cell ' num2str(i) ': ' num2str(mean(freq_matrix_29_smoothed(i, :))) ' Hz']);
end

if stim_time ~= 0
    disp(['Stimulus time point: ' num2str(stim_time) ' seconds']);
end